---
version: "3.7"

services:
  api:
    image: paper-identity/api
    build:
      context: service-api
      dockerfile: Dockerfile
    healthcheck:
      test: SCRIPT_NAME=/ping SCRIPT_FILENAME=/ping REQUEST_METHOD=GET cgi-fcgi -bind -connect 127.0.0.1:8000
      interval: 15s
      timeout: 10s
      retries: 3
      start_period: 30s

  front:
    image: paper-identity/front
    build:
      context: service-front
      dockerfile: Dockerfile
    depends_on:
      - api
    healthcheck:
      test: SCRIPT_NAME=/ping SCRIPT_FILENAME=/ping REQUEST_METHOD=GET cgi-fcgi -bind -connect 127.0.0.1:8000
      interval: 15s
      timeout: 10s
      retries: 3
      start_period: 30s
    volumes:
      - ./service-front:/app

  front-web:
    build: nginx
    depends_on: [front]
    environment:
      APP_HOST: front
      APP_NAME: front
      APP_PORT: 9000
      NGINX_LOG_LEVEL: info
    ports:
      - 8000:80
    healthcheck:
      test: curl -f http://localhost/nginx-health || exit 1
      interval: 15s
      timeout: 10s
      retries: 3
      start_period: 30s

  composer:
    image: composer
    command: [ "install" ]
