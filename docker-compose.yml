---
version: "3.7"

services:
  sirius-mock:
    image: stoplight/prism:5
    command: mock -h 0.0.0.0 -p 4010 -d /tmp/openapi.yml
    healthcheck:
      test: wget -O /dev/null -S 'http://localhost:4010/health-check' 2>&1 | grep 'HTTP/1.1 200 OK' || exit 1
      interval: 15s
      timeout: 10s
      retries: 3
      start_period: 30s
    volumes:
      - ./docker/sirius/openapi.yml:/tmp/openapi.yml

  api:
    image: paper-identity/api
    build:
      context: service-api
      dockerfile: Dockerfile
      target: production
    healthcheck:
      test: SCRIPT_NAME=/ping SCRIPT_FILENAME=/ping REQUEST_METHOD=GET cgi-fcgi -bind -connect 127.0.0.1:8000
      interval: 15s
      timeout: 10s
      retries: 3
      start_period: 30s
    volumes:
        - ./service-api:/var/www
        - ./service-api/config/development.config.php.dist:/var/www/config/development.config.php

  api-test:
    image: paper-identity/api-test
    build:
      context: service-api
      dockerfile: Dockerfile
      target: development
    healthcheck:
      test: SCRIPT_NAME=/ping SCRIPT_FILENAME=/ping REQUEST_METHOD=GET cgi-fcgi -bind -connect 127.0.0.1:8000
      interval: 15s
      timeout: 10s
      retries: 3
      start_period: 30s
    volumes:
      - ./service-api/build:/var/www/build

  front:
    image: paper-identity/front
    build:
      context: service-front
      dockerfile: Dockerfile
    depends_on:
      - api
      - sirius-mock
    environment:
      - SIRIUS_BASE_URL=http://sirius-mock:4010 # http://host.docker.internal:8080 for real Sirius
      - SIRIUS_LOGIN_URL=http://localhost:8080
    healthcheck:
      test: SCRIPT_NAME=/ping SCRIPT_FILENAME=/ping REQUEST_METHOD=GET cgi-fcgi -bind -connect 127.0.0.1:8000
      interval: 15s
      timeout: 10s
      retries: 3
      start_period: 30s
    volumes:
      - ./service-front:/var/www
      - ./service-front/config/development.config.php.dist:/var/www/config/development.config.php
      - static-content:/var/www/public

  front-test:
    image: paper-identity/front-test
    build:
      context: service-front
      dockerfile: Dockerfile
      target: development
    healthcheck:
      test: SCRIPT_NAME=/ping SCRIPT_FILENAME=/ping REQUEST_METHOD=GET cgi-fcgi -bind -connect 127.0.0.1:8000
      interval: 15s
      timeout: 10s
      retries: 3
      start_period: 30s
    volumes:
      - ./service-front/build:/var/www/build

  api-web:
      build: nginx
      depends_on: [api]
      environment:
        APP_HOST: api
        APP_NAME: api
        APP_PORT: 9000
        NGINX_LOG_LEVEL: info
      ports:
        - 8001:80
      healthcheck:
        test: curl -f http://localhost/nginx-health || exit 1
        interval: 15s
        timeout: 10s
        retries: 3
        start_period: 30s

  front-web:
     build: nginx
     depends_on: [front]
     environment:
       APP_HOST: front
       APP_NAME: front
       APP_PORT: 9000
       NGINX_LOG_LEVEL: info
     ports:
       - 8081:80
     healthcheck:
       test: curl -f http://localhost/nginx-health || exit 1
       interval: 15s
       timeout: 10s
       retries: 3
       start_period: 30s
     volumes:
       - static-content:/var/www/public

  api-composer:
    image: composer
    command: [ "install", "--ignore-platform-reqs" ]
    volumes:
      - ~/.composer:/tmp
      - ./service-api:/app

  front-composer:
    image: composer
    command: [ "install", "--ignore-platform-reqs" ]
    volumes:
      - ~/.composer:/tmp
      - ./service-front:/app

volumes:
  static-content:
